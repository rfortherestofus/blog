---
title: "Refugees animation"
author: David Keyes
date: 1/17/2024
toc: false
format: gfm
wrap: none
knitr:
  opts_chunk:
    out.width: 100%
    fig.height: 8
    dpi: 300
    collapse: true
    comment: "#>"
    warning: false
    message: false
editor_options: 
  chunk_output_type: console
---

```{r}
# Load necessary libraries
library(tidyverse)
library(gganimate)
library(sf)
library(refugees)
library(viridis)
library(RColorBrewer)
library(scales)
```

# Data

```{r}
population

filtered_data <-
  population |>
  group_by(year, coa_name) |>
  summarise(refugees = sum(refugees, na.rm = TRUE)) |>
  ungroup() |>
  filter(year >= 2000)
```


# Plot


```{r}
# Create the facetted animated plot
animated_plot <-
  ggplot(filtered_data, aes(x = year, y = refugees, color = coa_name, group = coa_name)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Evolution of Refugees per Country (Top 8)",
    x = "Year",
    y = "Number of Refugees",
    color = "Country of Asylum"
  ) +
  # Use a color-blind-friendly or aesthetically pleasing palette
  scale_color_viridis_d(option = "C") + # Alternative: scale_color_brewer(palette = "Set2")
  theme_minimal(base_size = 15) +
  theme(
    legend.position = "none", # Hide the legend in facetted plots
    plot.title = element_text(size = 20, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  facet_wrap(~coa_name, scales = "free_y") + # Facet by country of asylum
  transition_reveal(year)

# Save the animation as a gif
anim_save("refugees_evolution_facetted.gif", animation = animated_plot)
```




# Map

```{r}
geodata <- read_sf("refugees-animation/countries.geojson") %>%
  filter(ADMIN != "Antarctica")

world_pop <- read_csv("refugees-animation/population-and-demography.csv", show_col_types = FALSE)

all_countries_years <- expand.grid(
  year = unique(population$year),
  coa_iso = unique(geodata$ISO_A3)
)

refugee_data <- population %>%
  select(year, coa_name, coa_iso, refugees) %>%
  group_by(year, coa_name, coa_iso) %>%
  summarise(refugees = sum(refugees, na.rm = TRUE)) %>%
  ungroup() %>%
  right_join(all_countries_years, by = c("year", "coa_iso")) %>%
  mutate(refugees = ifelse(is.na(refugees), NA, refugees))

map_data <- geodata %>%
  left_join(refugee_data, by = c("ISO_A3" = "coa_iso"), relationship = "many-to-many") %>%
  select(geometry, year, coa_name, refugees, ISO_A3) %>%
  left_join(world_pop, by = c("year" = "Year", "ISO_A3" = "Code")) %>%
  mutate(refugee_per_cap = refugees / Population * 100)

p <- ggplot(map_data, aes(fill = refugee_per_cap)) +
  geom_sf(linewidth = 0.2, color = "black") +
  scale_fill_gradientn(
    colours = c("blue", "red"),
    na.value = "lightgrey",
    limits = range(map_data$refugee_per_cap, na.rm = TRUE),
    name = "Refugees per capita",
    labels = comma
  ) +
  theme_void() +
  labs(
    title = "Evolution of Refugees/capita Over Time",
    subtitle = "Year: {current_frame}",
    fill = "Refugees"
  ) +
  theme(
    legend.position = "bottom",
    legend.key.width = unit(2, "cm"),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    plot.title = element_text(hjust = 0.5, size = 20),
    plot.subtitle = element_text(hjust = 0.5, size = 16)
  ) +
  coord_sf(crs = st_crs(3857))


animated_map <- p +
  transition_manual(year)

anim_save(
  "refugees-animation/animated_refugee_map.gif",
  animated_map,
  fps = 5,
  width = 1200, height = 800, res = 150, # Higher resolution
  renderer = gifski_renderer(loop = TRUE)
)
```
